<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Story Voice Generator â€“ Level 4 Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #1e293b 60%, #0f172a);
            color: #e2e8f0;
            font-family: "Inter", sans-serif;
        }

        .app-title {
            font-weight: 800;
            font-size: 36px;
            background: linear-gradient(to right, #38bdf8, #818cf8, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            backdrop-filter: blur(16px);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 45px rgba(0, 0, 0, 0.45);
            position: relative;
        }

        textarea, .form-select, .form-control {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: #ffffff !important;
        }
        textarea { resize: none; }
        textarea::placeholder { color: #cbd5e1; }

        .form-select option { color: black !important; background: white; }

        /* Cancel button in top right */
        .cancel-top {
            position: absolute;
            top: 10px;
            right: 14px;
            color: #f87171;
            cursor: pointer;
            font-weight: 600;
        }

        /* Success Panel */
        .success-box {
            background: rgba(34,197,94,0.15);
            border: 1px solid #22c55e55;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>

<body>

<div class="container py-4">

    <h2 class="app-title mb-4">AI Story Voice Generator</h2>

    <div class="row g-4">

        <!-- LEFT CARD -->
        <div class="col-lg-8">
            <div class="glass-card">

                <!-- TOP CANCEL BUTTON -->
                <div id="cancelTop" class="cancel-top" style="display:none;" onclick="cancelJob()">
                    âœ– Cancel
                </div>

                <!-- PREVIEW PLAYER -->
                <audio id="previewPlayer" controls style="display:none; width:100%; margin-bottom:10px;"></audio>

                <!-- MAIN FORM -->
                <form id="ttsForm" onsubmit="return false;">

                    <label class="fw-bold">Story / Script Text</label>
                    <textarea name="text" rows="10" class="form-control mb-3"
                              placeholder="Paste your story/script here..."></textarea>

                    <!-- Buttons -->
                    <div class="d-flex gap-2 mb-3">
                        <button type="button" onclick="previewVoice()" class="btn btn-info">ðŸŽ§ Preview</button>
                        <button type="button" onclick="clearText()" class="btn btn-secondary">ðŸ§¹ Clear</button>
                    </div>

                    <!-- Options -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-2">
                            <label>Voice</label>
                            <select name="voice" class="form-select">
                                {% for vid, vlabel in voices %}
                                <option value="{{ vid }}">{{ vlabel }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3 mb-2">
                            <label>Speed</label>
                            <select name="speed" class="form-select">
                                <option>Slow</option>
                                <option selected>Normal</option>
                                <option>Fast</option>
                            </select>
                        </div>

                        <div class="col-md-3 mb-2">
                            <label>Tone</label>
                            <select name="tone" class="form-select">
                                <option selected>Normal</option>
                                <option>Deep</option>
                                <option>Soft</option>
                                <option>Deep Male</option>
                                <option>Soft Female</option>
                            </select>
                        </div>
                    </div>

                    <label>Format</label>
                    <select name="format" class="form-select mb-3" style="max-width:150px;">
                        <option selected>mp3</option>
                    </select>

                    <div id="errorBox" class="text-danger mb-2" style="display:none;"></div>

                    <!-- PROGRESS -->
                    <div id="progressBox" style="display:none;">
                        <p class="mb-1">Progress: <span id="pText">0%</span></p>
                        <div class="progress mb-2">
                            <div id="pBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width:0%"></div>
                        </div>
                        <p class="small text-muted">Estimated time remaining: <span id="eta">0</span> sec</p>

                        <button type="button" onclick="cancelJob()" class="btn btn-danger w-100 mt-2">
                            Cancel Generation
                        </button>
                    </div>

                    <!-- GENERATE -->
                    <button id="genBtn" type="button" onclick="startJob()" class="btn btn-primary w-100 mt-2">
                        ðŸ”Š Generate Audio
                    </button>

                    <!-- SUCCESS (RESULT) BOX -->
                    <div id="successBox" class="success-box">
                        <h6 class="text-success fw-bold mb-2">âœ” Voice is ready!</h6>
                        <div class="d-flex gap-2">
                            <a id="btnDownload" href="#" class="btn btn-primary btn-sm">â¬‡ Download Audio</a>
                        </div>
                    </div>

                </form>

            </div>
        </div>

        <!-- TIPS -->
        <div class="col-lg-4">
            <div class="glass-card">
                <h6 class="fw-bold mb-2">Tips</h6>
                <ul class="small">
                    <li>Best for YouTube: <b>Guy (Deep Male)</b></li>
                    <li>Best Urdu voices: <b>Asad</b>, <b>Uzma</b></li>
                    <li>Best Hindi voices: <b>Madhur</b>, <b>Swara</b></li>
                    <li>MP3 recommended for performance.</li>
                </ul>
            </div>
        </div>

    </div>
</div>


<script>
// GLOBALS
let currentJob = null;
let progressTimer = null;

// Clear Text
function clearText() {
    document.querySelector("textarea[name='text']").value = "";
}

// Preview (15-20 sec)
function previewVoice() {
    const text = document.querySelector("textarea[name='text']").value.trim();
    if (!text) return alert("Enter text first!");

    fetch("/preview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            text,
            voice: document.querySelector("select[name='voice']").value,
            speed: document.querySelector("select[name='speed']").value,
            tone: document.querySelector("select[name='tone']").value,
        })
    })
    .then(r => r.blob())
    .then(blob => {
        const player = document.getElementById("previewPlayer");
        player.src = URL.createObjectURL(blob);
        player.style.display = "block";
        player.play();
    });
}

// START JOB
function startJob() {
    const text = document.querySelector("textarea[name='text']").value.trim();
    if (!text) return alert("Please enter text.");

    document.getElementById("progressBox").style.display = "block";
    document.getElementById("cancelTop").style.display = "block";
    document.getElementById("successBox").style.display = "none";

    document.getElementById("genBtn").disabled = true;

    fetch("/start-job", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            text,
            voice: document.querySelector("select[name='voice']").value,
            speed: document.querySelector("select[name='speed']").value,
            tone: document.querySelector("select[name='tone']").value
        })
    })
    .then(r => r.json())
    .then(data => {
        currentJob = data.job_id;
        progressTimer = setInterval(checkProgress, 800);
    });
}

// POLLING PROGRESS
function checkProgress() {
    fetch("/progress/" + currentJob)
        .then(r => r.json())
        .then(job => {

            if (job.error) {
                alert("Error: " + job.error);
                clearInterval(progressTimer);
                return;
            }

            document.getElementById("pText").innerText = job.progress + "%";
            document.getElementById("pBar").style.width = job.progress + "%";
            document.getElementById("eta").innerText = job.eta;

            if (job.done) {
                clearInterval(progressTimer);
                showSuccess(job);
            }
        });
}

// CANCEL JOB
function cancelJob() {
    fetch("/cancel/" + currentJob, { method: "POST" });
    clearInterval(progressTimer);
    alert("Generation cancelled.");
    location.reload();
}

// SHOW SUCCESS
function showSuccess(job) {
    document.getElementById("cancelTop").style.display = "none";

    document.getElementById("successBox").style.display = "block";
    document.getElementById("btnDownload").href = "/download/" + currentJob;

    document.getElementById("genBtn").disabled = false;
}

</script>

</body>
</html>
